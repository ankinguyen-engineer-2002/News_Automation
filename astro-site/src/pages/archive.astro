---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL;
const allArticles = await getCollection("articles");

// Get unique dates and sort descending
const dates = [...new Set(allArticles.map(a => a.data.date))].sort().reverse();

// Group dates by month
const datesByMonth = dates.reduce((acc, date) => {
  const monthKey = date.substring(0, 7); // YYYY-MM
  if (!acc[monthKey]) acc[monthKey] = [];
  acc[monthKey].push(date);
  return acc;
}, {} as Record<string, string[]>);

const months = Object.keys(datesByMonth).sort().reverse();

// Format month
function formatMonth(key: string) {
  const date = new Date(key + '-01');
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
}

// Count articles per date
function countArticles(date: string) {
  return allArticles.filter(a => a.data.date === date).length;
}
---

<Layout title="Archive - Daily Intel">
  <Container>
    <div class="py-12">
      <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2" data-lang-en>Archive</h1>
      <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2 hidden" data-lang-vi>Lưu Trữ</h1>
      <p class="text-slate-600 dark:text-slate-400 mb-8">
        Browse past daily intelligence reports
      </p>
      
      {months.map(month => (
        <section class="mb-8">
          <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">
            {formatMonth(month)}
          </h2>
          
          <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            {datesByMonth[month].map(date => {
              const dayNum = parseInt(date.split('-')[2]);
              const dayName = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short' });
              const count = countArticles(date);
              
              return (
                <a 
                  href={`${base}/daily/${date}`}
                  class="group flex items-center gap-3 p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg hover:border-indigo-300 dark:hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition"
                >
                  <div class="w-10 h-10 flex items-center justify-center bg-slate-100 dark:bg-slate-700 group-hover:bg-indigo-600 group-hover:text-white rounded-lg font-bold transition">
                    {dayNum}
                  </div>
                  <div>
                    <div class="font-medium text-slate-900 dark:text-white">{dayName}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">{count} articles</div>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      ))}
      
      {dates.length === 0 && (
        <div class="text-center py-12">
          <p class="text-slate-500 dark:text-slate-400">No reports yet.</p>
        </div>
      )}
    </div>
  </Container>
</Layout>
