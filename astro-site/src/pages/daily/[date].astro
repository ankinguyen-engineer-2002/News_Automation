---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import ArticleCard from "@/components/ArticleCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const articles = await getCollection("articles");
  const dates = [...new Set(articles.map(a => a.data.date))];
  
  return dates.map(date => ({
    params: { date },
    props: { date },
  }));
}

const base = import.meta.env.BASE_URL;
const { date } = Astro.props;
const allArticles = await getCollection("articles");

// Filter articles for this date
const articles = allArticles
  .filter(a => a.data.date === date)
  .sort((a, b) => a.data.number - b.data.number);

// Group by topic
const topics = [
  { slug: "microsoft", icon: "üî∑", title: "Microsoft" },
  { slug: "data-platform", icon: "üî∂", title: "Data Platform" },
  { slug: "analytics-engineering", icon: "üü¢", title: "Analytics" },
  { slug: "ai-agents", icon: "üü£", title: "AI / LLM" },
  { slug: "automation", icon: "üî¥", title: "Automation" },
  { slug: "github", icon: "‚ö™", title: "GitHub" },
];

const articlesByTopic = topics.map(topic => ({
  ...topic,
  articles: articles.filter(a => a.data.topic === topic.slug),
})).filter(t => t.articles.length > 0);

// Format date
const dateObj = new Date(date + 'T00:00:00');
const formatted = dateObj.toLocaleDateString('en-US', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout title={`${date} - Daily Intel`}>
  <Container>
    <div class="py-12">
      <!-- Header -->
      <div class="mb-8">
        <a href={`${base}/archive`} class="text-sm text-slate-500 hover:text-slate-700 mb-2 inline-block">
          ‚Üê Archive
        </a>
        <h1 class="text-3xl font-bold text-slate-900 mb-2">{formatted}</h1>
        <p class="text-slate-600">
          {articles.length} articles across {articlesByTopic.length} topics
        </p>
      </div>
      
      <!-- Overview -->
      <div class="flex flex-wrap gap-2 mb-8">
        {articlesByTopic.map(topic => (
          <a 
            href={`#${topic.slug}`}
            class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium transition"
          >
            {topic.icon} {topic.title} ({topic.articles.length})
          </a>
        ))}
      </div>
      
      <!-- Articles by topic -->
      {articlesByTopic.map(topic => (
        <section id={topic.slug} class="mb-12">
          <h2 class="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
            <span>{topic.icon}</span>
            <span>{topic.title}</span>
            <span class="h-px flex-1 bg-slate-200"></span>
          </h2>
          
          <div class="grid md:grid-cols-2 gap-4">
            {topic.articles.map(article => (
              <ArticleCard
                number={article.data.number}
                date={article.data.date}
                title={article.data.title}
                title_vi={article.data.title_vi}
                source={article.data.source}
                excerpt={article.data.excerpt}
                excerpt_vi={article.data.excerpt_vi}
                url={article.data.url}
                slug={article.slug}
                topic={article.data.topic}
              />
            ))}
          </div>
        </section>
      ))}
    </div>
  </Container>
</Layout>
