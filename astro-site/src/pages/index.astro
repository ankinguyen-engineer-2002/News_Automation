---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import TopicCard from "@/components/TopicCard.astro";
import ArticleCard from "@/components/ArticleCard.astro";
import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL;

// Get all articles
const allArticles = await getCollection("articles");

// Get latest date
const dates = [...new Set(allArticles.map(a => a.data.date))].sort().reverse();
const latestDate = dates[0] || new Date().toISOString().split('T')[0];

// Topic definitions
const topics = [
  { title: "Microsoft", slug: "microsoft", desc: "Power BI, Fabric, Azure Data" },
  { title: "Data Platform", slug: "data-platform", desc: "Databricks, Snowflake, BigQuery" },
  { title: "Analytics", slug: "analytics-engineering", desc: "dbt, Airflow, Dagster" },
  { title: "AI / LLM", slug: "ai-agents", desc: "OpenAI, Claude, Gemini" },
  { title: "Automation", slug: "automation", desc: "n8n, Temporal, CI/CD" },
  { title: "GitHub", slug: "github", desc: "Blog, Changelog, Trending" },
];

// Count articles per topic
const topicCounts = topics.map(t => ({
  ...t,
  count: allArticles.filter(a => a.data.topic === t.slug).length,
}));

// Latest articles
const latestArticles = allArticles
  .filter(a => a.data.date === latestDate)
  .sort((a, b) => a.data.number - b.data.number)
  .slice(0, 6);
---

<Layout title="Daily Engineering Intelligence">
  <Container>
    <!-- Hero Section -->
    <div class="py-16 text-center">
      <span class="inline-block px-3 py-1 text-sm font-medium bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-full mb-4">
        Updated Daily via GitHub Actions
      </span>
      <h1 class="text-4xl lg:text-5xl font-bold text-slate-900 dark:text-white mb-4" data-lang-en>
        Daily Engineering Intelligence
      </h1>
      <h1 class="text-4xl lg:text-5xl font-bold text-slate-900 dark:text-white mb-4 hidden" data-lang-vi>
        Tin T·ª©c K·ªπ Thu·∫≠t H√†ng Ng√†y
      </h1>
      <p class="text-xl text-slate-600 dark:text-slate-400 max-w-2xl mx-auto" data-lang-en>
        AI-curated news for Data Engineering, Analytics & AI ‚Äî delivered fresh every day.
      </p>
      <p class="text-xl text-slate-600 dark:text-slate-400 max-w-2xl mx-auto hidden" data-lang-vi>
        Tin t·ª©c v·ªÅ Data Engineering, Analytics & AI ƒë∆∞·ª£c AI t·ªïng h·ª£p m·ªói ng√†y.
      </p>
      
      <div class="flex flex-wrap gap-4 justify-center mt-8">
        <a href={`${base}/daily/${latestDate}`} class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition">
          üì∞ Latest Report
        </a>
        <a href={`${base}/archive`} class="px-6 py-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg font-medium hover:bg-slate-300 dark:hover:bg-slate-600 transition">
          üìö Browse Archive
        </a>
      </div>
    </div>
    
    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 py-8 border-y border-slate-200 dark:border-slate-700">
      <div class="text-center">
        <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">17+</div>
        <div class="text-sm text-slate-500 dark:text-slate-400">Sources</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">6</div>
        <div class="text-sm text-slate-500 dark:text-slate-400">Topics</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">{allArticles.length}</div>
        <div class="text-sm text-slate-500 dark:text-slate-400">Articles</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">Daily</div>
        <div class="text-sm text-slate-500 dark:text-slate-400">Updates</div>
      </div>
    </div>
    
    <!-- Topics Grid -->
    <section class="py-12">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Browse by Topic</h2>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {topicCounts.map(topic => (
          <TopicCard 
            title={topic.title}
            slug={topic.slug}
            description={topic.desc}
            count={topic.count}
          />
        ))}
      </div>
    </section>
    
    <!-- Latest Articles -->
    {latestArticles.length > 0 && (
      <section class="py-12">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Latest Articles</h2>
          <a href={`${base}/daily/${latestDate}`} class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
            View all ‚Üí
          </a>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          {latestArticles.map(article => (
            <ArticleCard
              number={article.data.number}
              date={article.data.date}
              title={article.data.title}
              title_vi={article.data.title_vi}
              source={article.data.source}
              excerpt={article.data.excerpt}
              excerpt_vi={article.data.excerpt_vi}
              url={article.data.url}
              slug={article.slug}
              topic={article.data.topic}
            />
          ))}
        </div>
      </section>
    )}
  </Container>
</Layout>
