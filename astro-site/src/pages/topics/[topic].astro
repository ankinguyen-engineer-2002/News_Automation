---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import ArticleCard from "@/components/ArticleCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const topics = [
    { slug: "microsoft", icon: "üî∑", title: "Microsoft Data & Analytics" },
    { slug: "data-platform", icon: "üî∂", title: "Data Platform" },
    { slug: "analytics-engineering", icon: "üü¢", title: "Analytics Engineering" },
    { slug: "ai-agents", icon: "üü£", title: "AI / LLM / Agents" },
    { slug: "automation", icon: "üî¥", title: "Automation & DevOps" },
    { slug: "github", icon: "‚ö™", title: "GitHub & Open Source" },
  ];
  
  return topics.map(topic => ({
    params: { topic: topic.slug },
    props: { topic },
  }));
}

const base = import.meta.env.BASE_URL;
const { topic } = Astro.props;
const allArticles = await getCollection("articles");

// Filter and sort articles for this topic
const articles = allArticles
  .filter(a => a.data.topic === topic.slug)
  .sort((a, b) => {
    // Sort by date descending, then by number ascending
    if (a.data.date !== b.data.date) {
      return b.data.date.localeCompare(a.data.date);
    }
    return a.data.number - b.data.number;
  });

// Group by date
const articlesByDate = articles.reduce((acc, article) => {
  const date = article.data.date;
  if (!acc[date]) acc[date] = [];
  acc[date].push(article);
  return acc;
}, {} as Record<string, typeof articles>);

const dates = Object.keys(articlesByDate).sort().reverse();
---

<Layout title={`${topic.icon} ${topic.title} - Daily Intel`}>
  <Container>
    <div class="py-12">
      <!-- Header -->
      <div class="mb-8">
        <a href={base || "/"} class="text-sm text-slate-500 hover:text-slate-700 mb-2 inline-block">
          ‚Üê Back to Home
        </a>
        <div class="flex items-center gap-4">
          <span class="text-5xl">{topic.icon}</span>
          <div>
            <h1 class="text-3xl font-bold text-slate-900">{topic.title}</h1>
            <p class="text-slate-600">{articles.length} articles in playlist</p>
          </div>
        </div>
      </div>
      
      <!-- Articles by date -->
      {dates.map(date => (
        <section class="mb-12">
          <h2 class="text-lg font-semibold text-slate-700 mb-4 flex items-center gap-2">
            <span class="font-mono text-indigo-600">{date}</span>
            <span class="h-px flex-1 bg-slate-200"></span>
            <span class="text-sm text-slate-400">{articlesByDate[date].length} articles</span>
          </h2>
          
          <div class="space-y-4">
            {articlesByDate[date].map(article => (
              <ArticleCard
                number={article.data.number}
                date={article.data.date}
                title={article.data.title}
                title_vi={article.data.title_vi}
                source={article.data.source}
                excerpt={article.data.excerpt}
                excerpt_vi={article.data.excerpt_vi}
                url={article.data.url}
                slug={article.slug}
                topic={article.data.topic}
              />
            ))}
          </div>
        </section>
      ))}
      
      {articles.length === 0 && (
        <div class="text-center py-12">
          <p class="text-slate-500">No articles yet in this topic.</p>
        </div>
      )}
    </div>
  </Container>
</Layout>
