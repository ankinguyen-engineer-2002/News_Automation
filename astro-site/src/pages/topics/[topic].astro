---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import ArticleCard from "@/components/ArticleCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const topics = [
    { slug: "microsoft", title: "Microsoft Data & Analytics" },
    { slug: "data-platform", title: "Data Platform" },
    { slug: "analytics-engineering", title: "Analytics Engineering" },
    { slug: "ai-agents", title: "AI / LLM / Agents" },
    { slug: "automation", title: "Automation & DevOps" },
    { slug: "github", title: "GitHub & Open Source" },
  ];
  
  return topics.map(topic => ({
    params: { topic: topic.slug },
    props: { topic },
  }));
}

const base = import.meta.env.BASE_URL;
const { topic } = Astro.props;
const allArticles = await getCollection("articles");

const topicColors: Record<string, string> = {
  'microsoft': 'topic-microsoft',
  'data-platform': 'topic-data-platform',
  'analytics-engineering': 'topic-analytics-engineering',
  'ai-agents': 'topic-ai-agents',
  'automation': 'topic-automation',
  'github': 'topic-github',
};

// Filter and sort articles for this topic
const articles = allArticles
  .filter(a => a.data.topic === topic.slug)
  .sort((a, b) => {
    // Sort by date descending, then by number ascending
    if (a.data.date !== b.data.date) {
      return b.data.date.localeCompare(a.data.date);
    }
    return a.data.number - b.data.number;
  });

// Group by date
const articlesByDate = articles.reduce((acc, article) => {
  const date = article.data.date;
  if (!acc[date]) acc[date] = [];
  acc[date].push(article);
  return acc;
}, {} as Record<string, typeof articles>);

const dates = Object.keys(articlesByDate).sort().reverse();
---

<Layout title={`${topic.title} - Daily Intel`}>
  <Container>
    <div class="py-12">
      <!-- Header -->
      <div class="mb-8">
        <a href={base || "/"} class="inline-flex items-center gap-1 text-sm text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 mb-4 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to Home
        </a>
        <div class="flex items-center gap-4">
          <span class={`w-12 h-12 rounded-lg ${topicColors[topic.slug]}`}></span>
          <div>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white">{topic.title}</h1>
            <p class="text-slate-600 dark:text-slate-400">{articles.length} articles in playlist</p>
          </div>
        </div>
      </div>
      
      <!-- Articles by date -->
      {dates.map(date => (
        <section class="mb-12">
          <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2">
            <span class="font-mono text-indigo-600 dark:text-indigo-400">{date}</span>
            <span class="h-px flex-1 bg-slate-200 dark:bg-slate-700"></span>
            <span class="text-sm text-slate-400 dark:text-slate-500">{articlesByDate[date].length} articles</span>
          </h2>
          
          <div class="space-y-4">
            {articlesByDate[date].map(article => (
              <ArticleCard
                number={article.data.number}
                date={article.data.date}
                title={article.data.title}
                title_vi={article.data.title_vi}
                source={article.data.source}
                excerpt={article.data.excerpt}
                excerpt_vi={article.data.excerpt_vi}
                url={article.data.url}
                slug={article.slug}
                topic={article.data.topic}
              />
            ))}
          </div>
        </section>
      ))}
      
      {articles.length === 0 && (
        <div class="text-center py-12">
          <p class="text-slate-500 dark:text-slate-400">No articles yet in this topic.</p>
        </div>
      )}
    </div>
  </Container>
</Layout>
